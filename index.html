<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="NESTO - Neurodiverse Education Support Tool. Offline-first adaptive learning platform for children aged 5-8. Non-medical, non-diagnostic micro-skill practice.">
    <meta name="keywords" content="neurodiverse learning, educational tool, visual learning, pattern recognition, sequencing activities">
    <meta name="author" content="NESTO Team">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NESTO">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="NESTO - Learning Support Tool">
    <meta property="og:description" content="Offline-first adaptive learning platform for neurodiverse children aged 5-8">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/4CAF50/ffffff?text=NESTO">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåà</text></svg>">
    
    <title>NESTO - Learning Support Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Comic Sans MS', sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #FFF9C4 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; transition: background 0.8s; }
        body.calm-mode { background: #F5F5F5; }
        .container { max-width: 900px; width: 100%; background: white; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 40px; }
        .calm-mode .container { padding: 60px; max-width: 700px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #4CAF50; font-size: 2.8em; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.2em; margin-top: 10px; }
        .mode-indicator { display: inline-block; padding: 8px 20px; background: #B39DDB; border-radius: 20px; font-size: 1em; color: white; margin-top: 10px; }
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .calm-mode .nav-grid { grid-template-columns: repeat(2, 1fr); gap: 35px; }
        .nav-btn { background: white; border: 4px solid #4CAF50; border-radius: 20px; padding: 35px 20px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .nav-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3); }
        .nav-btn .icon { font-size: 3.5em; margin-bottom: 15px; }
        .nav-btn .label { font-size: 1.2em; color: #333; font-weight: bold; }
        .activity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .back-btn { background: #FF9800; color: white; border: none; padding: 15px 30px; border-radius: 15px; font-size: 1.3em; cursor: pointer; }
        .activity-title { font-size: 2em; color: #4CAF50; }
        .activity-content { min-height: 450px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 30px; }
        .instruction { font-size: 1.4em; color: #555; text-align: center; line-height: 1.6; }
        .sequence-container { display: flex; gap: 25px; flex-wrap: wrap; justify-content: center; }
        .sequence-item { width: 140px; height: 140px; background: #E3F2FD; border: 4px solid #2196F3; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: all 0.3s; }
        .sequence-item:hover { transform: scale(1.08); }
        .sequence-item.selected { background: #81C784; border-color: #4CAF50; }
        .sequence-item .emoji { font-size: 3.5em; }
        .sequence-item .text { font-size: 1em; color: #333; margin-top: 8px; font-weight: 600; }
        .sequence-item .number { position: absolute; top: 8px; right: 8px; background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; }
        .sequence-item.selected .number { display: flex; }
        .pattern-container { display: flex; gap: 18px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .pattern-box { width: 90px; height: 90px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 3em; }
        .pattern-box.question { background: #FFF9C4; border: 4px dashed #FBC02D; }
        .pattern-options { display: flex; gap: 25px; margin-top: 35px; }
        .pattern-option { width: 90px; height: 90px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 3em; cursor: pointer; border: 4px solid #E0E0E0; transition: all 0.3s; }
        .pattern-option:hover { transform: scale(1.12); border-color: #4CAF50; }
        .category-container { display: flex; gap: 30px; width: 100%; }
        .category-zone { flex: 1; min-height: 280px; background: #FAFAFA; border: 4px dashed #BDBDBD; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .category-zone.drag-over { background: #E8F5E9; border-color: #4CAF50; }
        .category-label { font-size: 1.4em; font-weight: bold; color: #555; margin-bottom: 10px; }
        .draggable-item { width: 110px; height: 110px; background: white; border: 3px solid #4CAF50; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: move; }
        .draggable-item .emoji { font-size: 3em; }
        .draggable-item .label { font-size: 0.9em; color: #555; margin-top: 5px; font-weight: 600; }
        .items-pool { flex-direction: row !important; flex-wrap: wrap; min-height: auto !important; margin-top: 20px; }
        .cause-effect-container { display: flex; flex-direction: column; align-items: center; gap: 45px; }
        .cause-btn { width: 220px; height: 90px; background: #2196F3; color: white; border: none; border-radius: 15px; font-size: 1.6em; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .cause-btn:hover { background: #1976D2; transform: scale(1.08); }
        .effect-display { width: 320px; height: 220px; background: #FAFAFA; border: 4px solid #BDBDBD; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 5em; transition: all 0.6s; }
        .effect-display.active { background: #FFF9C4; border-color: #FBC02D; transform: scale(1.05); }
        .attention-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        .attention-item { width: 160px; height: 160px; background: white; border: 4px solid #9C27B0; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 4.5em; cursor: pointer; transition: all 0.3s; }
        .attention-item:hover { transform: scale(1.08); }
        .attention-item.correct { background: #C8E6C9; border-color: #4CAF50; }
        .discrimination-container { display: flex; gap: 35px; justify-content: center; }
        .disc-item { width: 160px; height: 160px; background: white; border: 4px solid #FF5722; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 4.5em; cursor: pointer; transition: all 0.3s; }
        .disc-item:hover { transform: scale(1.08); }
        .disc-item.different { border-color: #4CAF50; background: #C8E6C9; }
        .progress-indicator { display: flex; gap: 12px; justify-content: center; margin-top: 35px; }
        .progress-dot { width: 18px; height: 18px; background: #E0E0E0; border-radius: 50%; transition: all 0.4s; }
        .progress-dot.active { background: #4CAF50; transform: scale(1.2); }
        .controls { display: flex; gap: 20px; justify-content: center; margin-top: 35px; }
        .control-btn { padding: 16px 45px; border: none; border-radius: 15px; font-size: 1.3em; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .next-btn { background: #4CAF50; color: white; }
        .reset-btn { background: #FF9800; color: white; }
        .parent-link { position: fixed; bottom: 25px; right: 25px; padding: 12px 24px; background: #9C27B0; color: white; border-radius: 12px; text-decoration: none; font-size: 1em; font-weight: bold; cursor: pointer; }
        .calm-toggle { position: fixed; top: 25px; right: 25px; padding: 12px 24px; background: #9575CD; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: bold; }
        .hidden { display: none !important; }
        
        /* Parent View Styles */
        .parent-view { padding: 20px; }
        .parent-header { text-align: center; margin-bottom: 30px; }
        .parent-header h2 { color: #9C27B0; font-size: 2.2em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .stat-card .number { font-size: 3em; font-weight: bold; }
        .stat-card .label { font-size: 1.1em; opacity: 0.9; margin-top: 5px; }
        .chart-container { background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
        .chart-title { font-size: 1.5em; color: #333; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .bar-chart { display: flex; flex-direction: column; gap: 15px; }
        .bar-item { display: flex; align-items: center; gap: 15px; }
        .bar-label { min-width: 120px; font-weight: 600; color: #555; }
        .bar-wrapper { flex: 1; background: #e0e0e0; border-radius: 10px; height: 35px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 1s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-weight: bold; }
        .suggestions { background: #E8F5E9; padding: 20px; border-radius: 15px; border-left: 5px solid #4CAF50; }
        .suggestions h3 { color: #4CAF50; margin-bottom: 15px; }
        .suggestions ul { margin-left: 20px; line-height: 1.8; }
        .close-parent-btn { background: #FF9800; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 1.1em; cursor: pointer; margin-top: 20px; display: block; margin-left: auto; margin-right: auto; }
        
        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 20px; border-radius: 20px; }
            .header h1 { font-size: 2.2em; }
            .subtitle { font-size: 1em; }
            .nav-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .nav-btn { padding: 25px 15px; }
            .nav-btn .icon { font-size: 2.8em; }
            .nav-btn .label { font-size: 1em; }
            .activity-title { font-size: 1.5em; }
            .back-btn { padding: 12px 20px; font-size: 1.1em; }
            .instruction { font-size: 1.2em; }
            .sequence-item { width: 110px; height: 110px; }
            .sequence-item .emoji { font-size: 2.8em; }
            .sequence-item .text { font-size: 0.85em; }
            .pattern-box, .pattern-option { width: 70px; height: 70px; font-size: 2.5em; }
            .category-container { flex-direction: column; gap: 20px; }
            .category-zone { min-height: 200px; }
            .draggable-item { width: 90px; height: 90px; }
            .draggable-item .emoji { font-size: 2.5em; }
            .cause-btn { width: 180px; height: 75px; font-size: 1.3em; }
            .effect-display { width: 250px; height: 180px; font-size: 4em; }
            .attention-item, .disc-item { width: 130px; height: 130px; font-size: 3.5em; }
            .control-btn { padding: 12px 30px; font-size: 1.1em; }
            .calm-toggle, .parent-link { top: 10px; right: 10px; bottom: auto; padding: 8px 15px; font-size: 0.9em; }
            .parent-link { top: auto; bottom: 10px; }
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .stat-card .number { font-size: 2.5em; }
            .bar-label { min-width: 90px; font-size: 0.9em; }
            .chart-title { font-size: 1.2em; }
            .parent-header h2 { font-size: 1.8em; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 15px; }
            .header h1 { font-size: 1.8em; }
            .nav-grid { gap: 10px; }
            .nav-btn { padding: 20px 10px; }
            .nav-btn .icon { font-size: 2.5em; margin-bottom: 8px; }
            .nav-btn .label { font-size: 0.9em; }
            .sequence-item { width: 90px; height: 90px; }
            .sequence-item .emoji { font-size: 2.3em; }
            .pattern-box, .pattern-option { width: 60px; height: 60px; font-size: 2em; }
            .attention-item, .disc-item { width: 110px; height: 110px; font-size: 3em; }
            .activity-content { min-height: 350px; gap: 20px; }
            .chart-container { padding: 15px; }
            .bar-label { min-width: 70px; font-size: 0.85em; }
            .bar-wrapper { height: 30px; }
        }
        
        /* Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .activity-content { min-height: 300px; }
            .sequence-container, .pattern-container { gap: 15px; }
        }
        
        /* Tablet Optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container { max-width: 750px; }
            .nav-btn .icon { font-size: 3.2em; }
            .sequence-item { width: 130px; height: 130px; }
        }
    </style>
</head>
<body>
    <button class="calm-toggle" id="calmToggle">üåô Calm Mode</button>
    <div class="parent-link" id="parentLink">üë®‚Äçüë©‚Äçüëß Parent View</div>
    
    <div class="container">
        <div id="homeScreen">
            <div class="header">
                <h1>üåà NESTO</h1>
                <p class="subtitle">Choose an activity to practice</p>
                <div class="mode-indicator hidden" id="modeIndicator">üåô Calm Mode Active</div>
            </div>
            <div class="nav-grid">
                <div class="nav-btn" data-activity="sequencing"><div class="icon">üìã</div><div class="label">Order</div></div>
                <div class="nav-btn" data-activity="pattern"><div class="icon">üî∑</div><div class="label">Patterns</div></div>
                <div class="nav-btn" data-activity="category"><div class="icon">üì¶</div><div class="label">Sorting</div></div>
                <div class="nav-btn" data-activity="cause-effect"><div class="icon">üí°</div><div class="label">Actions</div></div>
                <div class="nav-btn" data-activity="attention"><div class="icon">üîç</div><div class="label">Find It</div></div>
                <div class="nav-btn" data-activity="discrimination"><div class="icon">üëÅÔ∏è</div><div class="label">Spot It</div></div>
            </div>
        </div>
        
        <div id="activityScreen" class="hidden">
            <div class="activity-header">
                <button class="back-btn" id="backBtn">‚Üê Back</button>
                <h2 class="activity-title" id="activityTitle"></h2>
            </div>
            <div class="activity-content" id="activityContent"></div>
            <div class="progress-indicator" id="progressIndicator"></div>
        </div>
        
        <div id="parentView" class="parent-view hidden">
            <div class="parent-header">
                <h2>üìä Practice Summary</h2>
                <p style="color: #666; margin-top: 10px;">Understanding your child's learning journey</p>
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="chart-container">
                <div class="chart-title">Activities Practiced</div>
                <div class="bar-chart" id="activityChart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Time Spent (Minutes)</div>
                <div class="bar-chart" id="timeChart"></div>
            </div>
            
            <div class="suggestions">
                <h3>üí° Offline Activity Suggestions</h3>
                <ul>
                    <li><strong>Sequencing Practice:</strong> Lay out morning routine pictures in order (wake up ‚Üí brush teeth ‚Üí eat breakfast)</li>
                    <li><strong>Pattern Making:</strong> Create patterns with household items (spoon-fork-spoon-fork)</li>
                    <li><strong>Sorting Games:</strong> Sort laundry by color or toys by type</li>
                    <li><strong>Cause & Effect:</strong> Practice with light switches, water taps, or door handles</li>
                    <li><strong>Finding Games:</strong> "I spy" with specific colors or shapes around the house</li>
                </ul>
            </div>
            
            <p style="text-align: center; color: #999; margin-top: 20px; font-size: 0.9em;">
                ‚ÑπÔ∏è This data is stored locally on your device. No scores, labels, or diagnoses provided.
            </p>
            
            <button class="close-parent-btn" id="closeParentBtn">Back to Activities</button>
        </div>
    </div>
    
    <script>
        let currentActivity = null;
        let activityProgress = 0;
        let calmMode = false;
        let selectedOrder = [];
        let startTime = 0;
        let rapidTapCount = 0;
        let lastTapTime = 0;
        let errorCount = 0;
        let draggedElement = null;

        let sessionData = {
            startTime: Date.now(),
            activities: [],
            signals: [],
            childId: localStorage.getItem('nesto-child-id') || generateChildId()
        };

        function generateChildId() {
            const id = 'child_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('nesto-child-id', id);
            return id;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('nesto-calm-mode') === 'true') {
                calmMode = true;
                document.body.classList.add('calm-mode');
                document.getElementById('modeIndicator').classList.remove('hidden');
            }

            document.getElementById('calmToggle').addEventListener('click', toggleCalmMode);
            document.getElementById('backBtn').addEventListener('click', goHome);
            document.getElementById('parentLink').addEventListener('click', showParentView);
            document.getElementById('closeParentBtn').addEventListener('click', closeParentView);

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => startActivity(btn.dataset.activity));
            });
        });

        function toggleCalmMode() {
            calmMode = !calmMode;
            document.body.classList.toggle('calm-mode');
            document.getElementById('modeIndicator').classList.toggle('hidden');
            localStorage.setItem('nesto-calm-mode', calmMode);
        }

        function startActivity(type) {
            currentActivity = type;
            activityProgress = 0;
            startTime = Date.now();
            errorCount = 0;
            
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('activityScreen').classList.remove('hidden');
            
            const titles = {
                'sequencing': 'üìã Put in Order',
                'pattern': 'üî∑ Complete the Pattern',
                'category': 'üì¶ Sort the Items',
                'cause-effect': 'üí° See What Happens',
                'attention': 'üîç Find the Match',
                'discrimination': 'üëÅÔ∏è Spot the Difference'
            };
            
            document.getElementById('activityTitle').textContent = titles[type];
            loadActivity(type);
            
            sessionData.activities.push({
                type: type,
                startTime: Date.now()
            });
        }

        function goHome() {
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('activityScreen').classList.add('hidden');
            
            if (sessionData.activities.length > 0) {
                const lastActivity = sessionData.activities[sessionData.activities.length - 1];
                lastActivity.endTime = Date.now();
                lastActivity.duration = lastActivity.endTime - lastActivity.startTime;
                saveSession();
            }
            
            currentActivity = null;
        }

        function loadActivity(type) {
            const content = document.getElementById('activityContent');
            content.innerHTML = '';
            
            switch(type) {
                case 'sequencing': loadSequencing(); break;
                case 'pattern': loadPattern(); break;
                case 'category': loadCategory(); break;
                case 'cause-effect': loadCauseEffect(); break;
                case 'attention': loadAttention(); break;
                case 'discrimination': loadDiscrimination(); break;
            }
            
            updateProgress(activityProgress, 3);
        }

        function updateProgress(current, total) {
            const indicator = document.getElementById('progressIndicator');
            indicator.innerHTML = '';
            for (let i = 0; i < total; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot' + (i <= current ? ' active' : '');
                indicator.appendChild(dot);
            }
        }

        function saveSession() {
            try {
                localStorage.setItem('nesto-session-' + Date.now(), JSON.stringify(sessionData));
                clearOldSessions();
            } catch (e) {
                clearOldSessions();
            }
        }

        function clearOldSessions() {
            const keys = Object.keys(localStorage).filter(k => k.startsWith('nesto-session-'));
            keys.sort();
            if (keys.length > 20) {
                keys.slice(0, -20).forEach(k => localStorage.removeItem(k));
            }
        }

        // SEQUENCING
        function loadSequencing() {
            const content = document.getElementById('activityContent');
            const sequences = [
                [{emoji:'üåÖ',text:'Wake Up',order:1},{emoji:'ü™•',text:'Brush',order:2},{emoji:'üç≥',text:'Eat',order:3}],
                [{emoji:'üå±',text:'Plant',order:1},{emoji:'üíß',text:'Water',order:2},{emoji:'üå∫',text:'Grows',order:3}],
                [{emoji:'ü•ö',text:'Egg',order:1},{emoji:'üê£',text:'Chick',order:2},{emoji:'üêî',text:'Hen',order:3}]
            ];
            
            const sequence = sequences[activityProgress % sequences.length];
            const shuffled = [...sequence].sort(() => Math.random() - 0.5);
            selectedOrder = [];
            
            content.innerHTML = `
                <div class="instruction">Tap the pictures in the right order</div>
                <div class="sequence-container" id="sequenceContainer"></div>
                <div class="controls">
                    <button class="control-btn reset-btn" id="resetSeq">Try Again</button>
                    <button class="control-btn next-btn" id="nextSeq">Next</button>
                </div>
            `;
            
            const container = document.getElementById('sequenceContainer');
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'sequence-item';
                div.dataset.order = item.order;
                div.innerHTML = `<div class="emoji">${item.emoji}</div><div class="text">${item.text}</div><div class="number"></div>`;
                div.onclick = function() {
                    if (!this.classList.contains('selected')) {
                        this.classList.add('selected');
                        selectedOrder.push(parseInt(this.dataset.order));
                        this.querySelector('.number').textContent = selectedOrder.length;
                    }
                };
                container.appendChild(div);
            });
            
            document.getElementById('resetSeq').onclick = loadSequencing;
            document.getElementById('nextSeq').onclick = () => {
                activityProgress++;
                if (activityProgress >= 3) activityProgress = 0;
                loadSequencing();
                updateProgress(activityProgress, 3);
            };
        }

        // PATTERN
        function loadPattern() {
            const content = document.getElementById('activityContent');
            const patterns = [
                {sequence:['üî¥','üîµ','üî¥','üîµ'],answer:'üî¥',options:['üî¥','üîµ','üü¢']},
                {sequence:['‚≠ê','‚≠ê','üåô','‚≠ê','‚≠ê'],answer:'üåô',options:['‚≠ê','üåô','‚òÄÔ∏è']},
                {sequence:['üî∫','üîª','üî∫','üîª'],answer:'üî∫',options:['üî∫','üîª','üî∂']}
            ];
            
            const pattern = patterns[activityProgress % patterns.length];
            
            content.innerHTML = `
                <div class="instruction">What comes next?</div>
                <div class="pattern-container" id="patternDisplay"></div>
                <div class="pattern-options" id="patternOptions"></div>
            `;
            
            const colors = {'üî¥':'#FFCDD2','üîµ':'#BBDEFB','üü¢':'#C8E6C9','‚≠ê':'#FFF9C4','üåô':'#E1BEE7','‚òÄÔ∏è':'#FFECB3','üî∫':'#FFCCBC','üîª':'#D1C4E9','üî∂':'#FFE082'};
            
            const display = document.getElementById('patternDisplay');
            pattern.sequence.forEach(item => {
                const box = document.createElement('div');
                box.className = 'pattern-box';
                box.style.background = colors[item] || '#F5F5F5';
                box.textContent = item;
                display.appendChild(box);
            });
            
            const questionBox = document.createElement('div');
            questionBox.className = 'pattern-box question';
            questionBox.textContent = '?';
            display.appendChild(questionBox);
            
            const optionsContainer = document.getElementById('patternOptions');
            pattern.options.forEach(option => {
                const optionBox = document.createElement('div');
                optionBox.className = 'pattern-option';
                optionBox.style.background = colors[option] || '#F5F5F5';
                optionBox.textContent = option;
                optionBox.onclick = () => {
                    setTimeout(() => {
                        activityProgress++;
                        if (activityProgress >= 3) activityProgress = 0;
                        loadPattern();
                        updateProgress(activityProgress, 3);
                    }, 500);
                };
                optionsContainer.appendChild(optionBox);
            });
        }

        // CATEGORY
        function loadCategory() {
            const content = document.getElementById('activityContent');
            
            content.innerHTML = `
                <div class="instruction">Drag items to sort them</div>
                <div class="category-container">
                    <div class="category-zone" id="zone1"><div class="category-label">üè† Indoor</div></div>
                    <div class="category-zone" id="zone2"><div class="category-label">üå≥ Outdoor</div></div>
                </div>
                <div class="category-zone items-pool" id="itemsPool"></div>
            `;
            
            const items = [
                {emoji:'üõãÔ∏è',label:'Sofa'},{emoji:'üå≥',label:'Tree'},
                {emoji:'üì∫',label:'TV'},{emoji:'üå∫',label:'Flower'}
            ];
            
            const pool = document.getElementById('itemsPool');
            items.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'draggable-item';
                div.draggable = true;
                div.id = 'item-' + i;
                div.innerHTML = `<div class="emoji">${item.emoji}</div><div class="label">${item.label}</div>`;
                div.ondragstart = (e) => { draggedElement = e.target; };
                pool.appendChild(div);
            });
            
            document.querySelectorAll('.category-zone').forEach(zone => {
                zone.ondragover = (e) => e.preventDefault();
                zone.ondrop = (e) => {
                    e.preventDefault();
                    if (draggedElement && e.currentTarget.classList.contains('category-zone')) {
                        e.currentTarget.appendChild(draggedElement);
                    }
                };
            });
        }

        // CAUSE AND EFFECT
        function loadCauseEffect() {
            const content = document.getElementById('activityContent');
            const effects = [
                {button:'üí° Press Switch',off:'‚¨õ',on:'üí°'},
                {button:'üö™ Open Door',off:'üö™',on:'üö™‚ú®'},
                {button:'‚òÅÔ∏è Rain Cloud',off:'üå±',on:'üå∫'}
            ];
            
            const effect = effects[activityProgress % effects.length];
            let isOn = false;
            
            content.innerHTML = `
                <div class="instruction">Tap to see what happens</div>
                <div class="cause-effect-container">
                    <button class="cause-btn" id="causeBtn">${effect.button}</button>
                    <div class="effect-display" id="effectDisplay">${effect.off}</div>
                </div>
                <div class="controls"><button class="control-btn next-btn" id="nextEffect">Next</button></div>
            `;
            
            const display = document.getElementById('effectDisplay');
            document.getElementById('causeBtn').onclick = () => {
                isOn = !isOn;
                display.textContent = isOn ? effect.on : effect.off;
                display.classList.toggle('active', isOn);
            };
            
            document.getElementById('nextEffect').onclick = () => {
                activityProgress++;
                if (activityProgress >= 3) activityProgress = 0;
                loadCauseEffect();
                updateProgress(activityProgress, 3);
            };
        }

        // ATTENTION
        function loadAttention() {
            const content = document.getElementById('activityContent');
            const challenges = [
                {target:'‚≠ê',options:['‚≠ê','üåô','‚òÄÔ∏è','‚≠ê']},
                {target:'üîµ',options:['üîµ','üî¥','üü¢','üîµ']},
                {target:'üê±',options:['üê±','üê∂','üê∞','üê±']}
            ];
            
            const challenge = challenges[activityProgress % challenges.length];
            const shuffled = [...challenge.options].sort(() => Math.random() - 0.5);
            
            content.innerHTML = `
                <div class="instruction">Find all the <span style="font-size:1.5em">${challenge.target}</span></div>
                <div class="attention-grid" id="attentionGrid"></div>
                <div class="controls"><button class="control-btn next-btn" id="nextAttention">Next</button></div>
            `;
            
            const grid = document.getElementById('attentionGrid');
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'attention-item';
                div.textContent = item;
                div.onclick = function() {
                    if (item === challenge.target) {
                        this.classList.add('correct');
                    }
                };
                grid.appendChild(div);
            });
            
            document.getElementById('nextAttention').onclick = () => {
                activityProgress++;
                if (activityProgress >= 3) activityProgress = 0;
                loadAttention();
                updateProgress(activityProgress, 3);
            };
        }

        // DISCRIMINATION
        function loadDiscrimination() {
            const content = document.getElementById('activityContent');
            const challenges = [
                {items:['üî¥','üî¥','üîµ'],different:'üîµ'},
                {items:['‚¨ÜÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è'],different:'‚¨áÔ∏è'},
                {items:['üòä','üòä','üò¢'],different:'üò¢'}
            ];
            
            const challenge = challenges[activityProgress % challenges.length];
            const shuffled = [...challenge.items].sort(() => Math.random() - 0.5);
            
            content.innerHTML = `
                <div class="instruction">Find the one that is different</div>
                <div class="discrimination-container" id="discContainer"></div>
                <div class="controls"><button class="control-btn next-btn" id="nextDisc">Next</button></div>
            `;
            
            const container = document.getElementById('discContainer');
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'disc-item';
                div.textContent = item;
                div.onclick = function() {
                    if (item === challenge.different) {
                        this.classList.add('different');
                    }
                };
                container.appendChild(div);
            });
            
            document.getElementById('nextDisc').onclick = () => {
                activityProgress++;
                if (activityProgress >= 3) activityProgress = 0;
                loadDiscrimination();
                updateProgress(activityProgress, 3);
            };
        }

        // PARENT VIEW
        function showParentView() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('activityScreen').classList.add('hidden');
            document.getElementById('parentView').classList.remove('hidden');
            
            loadParentData();
        }

        function closeParentView() {
            document.getElementById('parentView').classList.add('hidden');
            document.getElementById('homeScreen').classList.remove('hidden');
        }

        function loadParentData() {
            const sessions = Object.keys(localStorage)
                .filter(k => k.startsWith('nesto-session-'))
                .map(k => JSON.parse(localStorage.getItem(k)))
                .slice(-10);
            
            const activityCounts = {};
            const activityTimes = {};
            let totalActivities = 0;
            let totalTime = 0;
            let totalSessions = sessions.length;
            
            sessions.forEach(s => {
                s.activities.forEach(a => {
                    activityCounts[a.type] = (activityCounts[a.type] || 0) + 1;
                    if (a.duration) {
                        activityTimes[a.type] = (activityTimes[a.type] || 0) + a.duration;
                        totalTime += a.duration;
                    }
                    totalActivities++;
                });
            });
            
            // Stats Cards
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="number">${totalActivities}</div>
                    <div class="label">Activities Practiced</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="number">${totalSessions}</div>
                    <div class="label">Sessions Completed</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="number">${Math.round(totalTime / 60000)}</div>
                    <div class="label">Minutes Practiced</div>
                </div>
            `;
            
            // Activity Count Chart
            const activityChart = document.getElementById('activityChart');
            activityChart.innerHTML = '';
            
            const activityLabels = {
                'sequencing': 'üìã Order',
                'pattern': 'üî∑ Patterns',
                'category': 'üì¶ Sorting',
                'cause-effect': 'üí° Actions',
                'attention': 'üîç Find It',
                'discrimination': 'üëÅÔ∏è Spot It'
            };
            
            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
            
            Object.keys(activityCounts).forEach((type, index) => {
                const count = activityCounts[type];
                const maxCount = Math.max(...Object.values(activityCounts));
                const percentage = (count / maxCount) * 100;
                
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${activityLabels[type] || type}</div>
                    <div class="bar-wrapper">
                        <div class="bar-fill" style="width: ${percentage}%; background: ${colors[index % colors.length]};">
                            ${count}
                        </div>
                    </div>
                `;
                activityChart.appendChild(barItem);
            });
            
            // Time Chart
            const timeChart = document.getElementById('timeChart');
            timeChart.innerHTML = '';
            
            Object.keys(activityTimes).forEach((type, index) => {
                const time = Math.round(activityTimes[type] / 60000);
                const maxTime = Math.max(...Object.values(activityTimes).map(t => Math.round(t / 60000)));
                const percentage = (time / maxTime) * 100;
                
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${activityLabels[type] || type}</div>
                    <div class="bar-wrapper">
                        <div class="bar-fill" style="width: ${percentage}%; background: ${colors[index % colors.length]};">
                            ${time} min
                        </div>
                    </div>
                `;
                timeChart.appendChild(barItem);
            });
        }
    </script>
</body>
</html>
